<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Espace Client</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- Librairie Javascript: jQuery (v3.4.1) -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    </head>
    <body>
        <section id="header"></section>
        
        <script>
            $(document).ready(function() {
                $('#header').load('login.html');
            });
        </script>
        <h1 id='nomClient'></h1>
        <h2>Laissez les astres vous guider aujourd'hui</h2>
        
        <div id='profilAstral'>
            
        </div>
        
        <div>
            <h2>Contactez nos mediums dès maintenant</h2>
            
            <table id="liste-mediums">
                
            </table>
            
        </div>
        
        <div>
            <h2>Historique de vos derniers contacts</h2>
            
            <table id="historique-contacts">
                
            </table>
            
        </div>
        
        <script>
            $(document).ready(function() 
            {
                recupClient();
                recupListeMediums();
                recupHistoriqueCons();
            });
            
            function recupClient() {
                
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'recuperer-client'
                    },
                    dataType:'json'
                }).done(function (response) {
                    $('#profilAstral').append(
                            '<div> Votre signe astrologique : '+response.client.astral.zodiac + '</div>' +
                            '<div> Votre signe chinois : '+response.client.astral.chinois + '</div>' +
                            '<div> Votre couleur porte-bonheur : '+response.client.astral.couleur + '</div>' +
                            '<div> Votre animal totem : '+response.client.astral.animal + '</div>'
                    );
                    $('#nomClient').append(
                            'Bonjour '+response.client.prenom + ' !'
                    );
                })
                .fail(function(error) {
                    console.log('erreur récup client',error);
                });    
            }
            
            function recupListeMediums() {
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'lister-mediums'
                    },
                    dataType:'json'
                }).done(function (response) {
                    $('#liste-mediums').empty();
                    $.each(response.mediums, function(index,medium) {
                        if(medium.favori === true) {
                            $('#liste-mediums').append(
                                '<tr>'+
                                '<td> <div> <img src="static/images/icone_bonhomme.PNG" height="40"/> </div>' + medium.denomination + '</td>' +
                                '<td> <div>'+ medium.presentation + '<img src="static/images/Etoile_Favori.PNG" height="20" id ='+medium.id+'> </div>' + 
                                '<div>'+medium.type + 
                                '<button onclick=demanderConsultation('+medium.id+')> Contacter maintenant </button>' +
                                '</div> </td>' +
                                '</tr>'
                            );
                            listenerRetrait(medium.id);
                        } else {
                            $('#liste-mediums').append(
                                '<tr>'+
                                '<td> <div> <img src="static/images/icone_bonhomme.PNG" height="40"/> </div>' + medium.denomination + '</td>' +
                                '<td> <div>'+ medium.presentation + '<img src="static/images/Etoile_Non_Fav.PNG" height="20" id ='+medium.id+'> </div>' + 
                                '<div>'+medium.type + 
                                '<button onclick=demanderConsultation('+medium.id+')> Contacter maintenant </button>' +
                                '</div> </td>' +
                                '</tr>'
                            );
                            listenerAjout(medium.id);
                        }
                        
                    });
                })
                .fail(function(error) {
                    console.log('Erreur lors de la recup des Mediums',error);
                });                
            }
            
            function recupHistoriqueCons() {
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'historique-consultations-client'
                    },
                    dataType:'json'
                }).done(function (response) {
                    $('#historique-contacts').empty();
                    $.each(response.consultations, function(index,consultation) {
                        if(consultation.genreMedium === 'H') {
                            $('#historique-contacts').append(
                                '<tr>'+
                                '<td> <div> <img src="static/images/icone_bonhomme.PNG" height="40"/> </div>' + consultation.denominationMedium + '</td>' +
                                '<td> <div> Rencontré le ' +consultation.debut+
                                ', la consultation a duré '+consultation.duree+' minutes </div>' +
                                '<div>'+consultation.typeMedium +
                                '<button onclick=demanderConsultation('+consultation.idMedium+')> Recontacter maintenant </button>' +
                                '</div> </td>' +
                                '</tr>'
                            );
                        } else {
                            $('#historique-contacts').append(
                                '<tr>'+
                                '<td> <div> <img src="static/images/icone_bonhomme.PNG" height="40"/> </div>' + consultation.denominationMedium + '</td>' +
                                '<td> <div> Rencontrée le ' +consultation.debut+
                                ', la consultation a duré '+consultation.duree+' minutes </div>' +
                                '<div>'+consultation.typeMedium +
                                '<button onclick=demanderConsultation('+consultation.idMedium+')> Recontacter maintenant </button>' +
                                '</div> </td>' +
                                '</tr>'
                            );
                        }
                        
                    });
                })
                .fail(function(error) {
                    console.log('Erreur lors de la recup de l historique',error);
                });  
            }
            
            function demanderConsultation(idMed) {
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'demander-consultation',
                        idMedium:idMed
                    },
                    dataType:'json'
                }).done(function (response) {
                    console.log(response);
                    
                    if(response.success === true) {
                        window.location.href=('validation_contact.html?idMedium='+idMed);
                    } else {
                        alert(response.msgErreur);
                    }
                    
                })
                .fail(function(error) {
                    console.log('Erreur de creation de la consultation',error);
                });   
                
            }
            
            function listenerAjout(idMed) {
                var image = window.document.getElementById(idMed);
                image.addEventListener("click",function() {
                    image.setAttribute("src","static/images/Etoile_Favori.PNG");
                    
                    //Ajout au favoris du medium dans la BD
                    ajoutFavoris(idMed);
                    //Retrait du listener
                    imageClone = image.cloneNode(true);
                    image.parentNode.replaceChild(imageClone, image);
                    listenerRetrait(idMed);
                });
            }
            
            function listenerRetrait(idMed) {
                var image = window.document.getElementById(idMed);
                image.addEventListener("click",function() {
                    image.setAttribute("src","static/images/Etoile_Non_Fav.PNG");
                    
                    //Retrait des favoris du medium dans la BD
                    retraitFavoris(idMed);
                    //Retrait du listener
                    imageClone = image.cloneNode(true);
                    image.parentNode.replaceChild(imageClone, image);
                    listenerAjout(idMed);
                });
            }
            
            function ajoutFavoris(idMed) {
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'ajouter-favoris',
                        idMedium:idMed
                    },
                    dataType:'json'
                }).done(function (response) {
                    console.log(response.success);
                })
                .fail(function(error) {
                    console.log('Erreur d ajout aux favoris',error);
                });    
            }
            
            function retraitFavoris(idMed) {
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'retirer-favoris',
                        idMedium:idMed
                    },
                    dataType:'json'
                }).done(function (response) {
                    console.log(response.success);
                })
                .fail(function(error) {
                    console.log('Erreur d ajout aux favoris',error);
                });    
            }
            
        </script>
            
    </body>
</html>
