<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Espace Client</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- Librairie Javascript: jQuery (v3.4.1) -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    </head>
    <body>
        <section id="header"></section>
        
        <script>
            $(document).ready(function() {
                $('#header').load('login.html');
            });
        </script>
        <h1 id='nomClient'></h1>
        <h2>Laissez les astres vous guider aujourd'hui</h2>
        
        <div id='profilAstral'>
            
        </div>
        
        <div>
            <h2>Contactez nos mediums dès maintenant</h2>
            
            <table id="liste-mediums">
                
            </table>
            
        </div>
        
        <script>
            $(document).ready(function() 
            {
                var idClient = idFromCookie(recupCookie());
                recupClient(idClient);
                recupListeMediums(idClient);
            });
            
            function recupClient(idCli) {
                
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'recuperer-client',
                        id:idCli
                    },
                    dataType:'json'
                }).done(function (response) {
                    $('#profilAstral').append(
                            '<div> Votre signe astrologique : '+response.astral.zodiac + '</div>' +
                            '<div> Votre signe chinois : '+response.astral.chinois + '</div>' +
                            '<div> Votre couleur porte-bonheur : '+response.astral.couleur + '</div>' +
                            '<div> Votre animal totem : '+response.astral.animal + '</div>'
                    );
                    $('#nomClient').append(
                            'Bonjour '+response.prenom + ' !'
                    );
                })
                .fail(function(error) {
                    console.log('erreur récup client',error);
                });    
            }
            
            function recupListeMediums(idCli) {
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'lister-mediums',
                        idClient:idCli
                    },
                    dataType:'json'
                }).done(function (response) {
                    $('#liste-mediums').empty();
                    $.each(response.mediums, function(index,medium) {
                        if(medium.favori === true) {
                            $('#liste-mediums').append(
                                '<tr>'+
                                '<td> <div> <img src="icone_bonhomme.PNG" height="40"/> </div>' + medium.denomination + '</td>' +
                                '<td> <div>'+ medium.presentation + '<img src="Etoile_Favori.PNG" height="20" id ='+medium.id+'> </div>' + 
                                medium.type + '</td>' +
                                '</tr>'
                            );
                            listenerRetrait(idCli,medium.id);
                        } else {
                            $('#liste-mediums').append(
                                '<tr>'+
                                '<td> <div> <img src="icone_bonhomme.PNG" height="40"/> </div>' + medium.denomination + '</td>' +
                                '<td> <div>'+ medium.presentation + '<img src="Etoile_Non_Fav.PNG" height="20" id ='+medium.id+'> </div>' + 
                                medium.type + '</td>' +
                                '</tr>'
                            );
                            listenerAjout(idCli,medium.id);
                        }
                        
                    });
                })
                .fail(function(error) {
                    console.log('Erreur lors de la recup des Mediums',error);
                });                
            }
            
            function listenerAjout(idCli,idMed) {
                var image = window.document.getElementById(idMed);
                image.addEventListener("click",function() {
                    image.setAttribute("src","Etoile_Favori.PNG");
                    
                    //Ajout au favoris du medium dans la BD
                    ajoutFavoris(idCli,idMed);
                    //Retrait du listener
                    imageClone = image.cloneNode(true);
                    image.parentNode.replaceChild(imageClone, image);
                    listenerRetrait(idCli,idMed);
                });
            }
            
            function listenerRetrait(idCli,idMed) {
                var image = window.document.getElementById(idMed);
                image.addEventListener("click",function() {
                    image.setAttribute("src","Etoile_Non_Fav.PNG");
                    
                    //Retrait des favoris du medium dans la BD
                    retraitFavoris(idCli,idMed);
                    //Retrait du listener
                    imageClone = image.cloneNode(true);
                    image.parentNode.replaceChild(imageClone, image);
                    listenerAjout(idCli,idMed);
                });
            }
            
            function ajoutFavoris(idCli,idMed) {
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'ajouter-favoris',
                        idClient:idCli,
                        idMedium:idMed
                        
                    },
                    dataType:'json'
                }).done(function (response) {
                    console.log(response.success);
                })
                .fail(function(error) {
                    console.log('Erreur d ajout aux favoris',error);
                });    
            }
            
            function retraitFavoris(idCli,idMed) {
                $.ajax({
                    url: './ActionServlet',
                    method:'POST',
                    data: {
                        todo:'retirer-favoris',
                        idClient:idCli,
                        idMedium:idMed
                        
                    },
                    dataType:'json'
                }).done(function (response) {
                    console.log(response.success);
                })
                .fail(function(error) {
                    console.log('Erreur d ajout aux favoris',error);
                });    
            }
            
            function recupCookie(){
                let nameCookie = "id";
                let cookies = document.cookie.split(';');
                for(var i=0;i < cookies.length;i++) {
                    var c = cookies[i];
                    while (c.charAt(0)==' ') {
                        c = c.substring(1,c.length);
                    }
                    if (c.indexOf(nameCookie) == 0){
                        return nameCookie+c.substring(nameCookie.length,c.length);
                    }
                }
                return null;
            }
            
            function idFromCookie(cookie) {
                if (cookie === null) {
                    return null;
                }
                
                var start=3; //Début de la partie du cookie qui nous intéresse (les 3 premiers chars sont id=)
                var end=3;
                while(cookie.charAt(end) >= '0' && cookie.charAt(end) <= '9') { //Recherche de la fin du n° de l'id.
                    end++;
                }
                
                var id = cookie.substring(start,end);
                return id;
            }
            
        </script>
            
    </body>
</html>
